<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Supabase Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        .result { padding: 15px; margin: 10px 0; border-radius: 8px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .loading { opacity: 0.6; }
    </style>
</head>
<body>
    <h1>üîç Simple Supabase Connection Test</h1>
    
    <button onclick="testConnection()" id="test-btn">Test Connection Now</button>
    <button onclick="testWithSupabaseClient()" id="client-btn">Test Supabase Client</button>
    
    <div id="results">
        <div class="result info">
            <h3>üìã Ready to Test</h3>
            <p>Click "Test Connection Now" to check if your Supabase project is active.</p>
            <p><strong>Project:</strong> The Storyforge</p>
            <p><strong>URL:</strong> <code id="project-url">Loading...</code></p>
        </div>
    </div>

    <script type="module">
        const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
        const SUPABASE_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY;
        
        document.getElementById('project-url').textContent = SUPABASE_URL;
        
        function addResult(title, content, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<h3>${title}</h3><div>${content}</div><p><small>Time: ${new Date().toLocaleTimeString()}</small></p>`;
            document.getElementById('results').appendChild(div);
        }

        async function testConnection() {
            const btn = document.getElementById('test-btn');
            btn.disabled = true;
            btn.textContent = 'Testing...';
            btn.className = 'loading';

            addResult('üîÑ Testing Connection', 'Checking if Supabase project is responding...', 'info');

            try {
                // Test 1: Basic health check
                const healthResponse = await fetch(`${SUPABASE_URL}/health`, {
                    signal: AbortSignal.timeout(15000)
                });
                
                if (healthResponse.ok) {
                    addResult('‚úÖ Health Check Passed', 'Project is online and responding!', 'success');
                } else {
                    addResult('‚ö†Ô∏è Health Check Warning', `Got response ${healthResponse.status}, but project seems active`, 'info');
                }

                // Test 2: REST API
                const apiResponse = await fetch(`${SUPABASE_URL}/rest/v1/`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    signal: AbortSignal.timeout(15000)
                });

                if (apiResponse.ok) {
                    addResult('‚úÖ REST API Working', 'Database API is accessible!', 'success');
                    
                    // Test 3: Database table check
                    const tableResponse = await fetch(`${SUPABASE_URL}/rest/v1/profiles?select=count&limit=1`, {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        },
                        signal: AbortSignal.timeout(10000)
                    });

                    if (tableResponse.ok || tableResponse.status === 403) {
                        addResult('‚úÖ Database Schema OK', 'Tables are accessible (schema installed)', 'success');
                    } else if (tableResponse.status === 404) {
                        addResult('‚ö†Ô∏è Schema Issue', 'Tables not found - schema may need to be re-run', 'info');
                    }

                    // Test 4: Storage
                    const storageResponse = await fetch(`${SUPABASE_URL}/storage/v1/bucket`, {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        },
                        signal: AbortSignal.timeout(10000)
                    });

                    if (storageResponse.ok) {
                        const buckets = await storageResponse.json();
                        addResult('‚úÖ Storage Working', `Found ${buckets.length} storage buckets: ${buckets.map(b => b.name).join(', ') || 'none'}`, 'success');
                    } else {
                        addResult('‚ö†Ô∏è Storage Issue', `Storage API returned ${storageResponse.status}`, 'info');
                    }

                    addResult('üéâ Connection Successful!', 'Your Supabase project is fully active and ready to use!', 'success');

                } else {
                    addResult('‚ùå REST API Issue', `API returned status ${apiResponse.status}`, 'error');
                }

            } catch (error) {
                if (error.name === 'TimeoutError') {
                    addResult('‚ùå Connection Timeout', 'Project may still be waking up. Wait 2 minutes and try again.', 'error');
                } else {
                    addResult('‚ùå Connection Failed', `Error: ${error.message}. Project may be paused.`, 'error');
                }
            }

            btn.disabled = false;
            btn.textContent = 'Test Connection Now';
            btn.className = '';
        }

        async function testWithSupabaseClient() {
            const btn = document.getElementById('client-btn');
            btn.disabled = true;
            btn.textContent = 'Testing Client...';

            addResult('üîÑ Testing Supabase Client', 'Loading and testing the Supabase JavaScript client...', 'info');

            try {
                const { supabase } = await import('./lib/supabase.js');
                
                // Test auth
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                if (sessionError) throw sessionError;
                
                addResult('‚úÖ Supabase Client OK', 'JavaScript client library is working correctly', 'success');

                // Test a simple query
                const { data, error } = await supabase
                    .from('profiles')
                    .select('count')
                    .limit(1);

                if (error) {
                    if (error.code === 'PGRST116') {
                        addResult('‚ö†Ô∏è Table Not Found', 'Profiles table not found - schema may need to be run', 'info');
                    } else if (error.code === 'PGRST301') {
                        addResult('‚úÖ RLS Working', 'Row Level Security is properly configured', 'success');
                    } else {
                        addResult('‚ö†Ô∏è Query Issue', `Database query error: ${error.message}`, 'info');
                    }
                } else {
                    addResult('‚úÖ Database Query OK', 'Successfully queried the database', 'success');
                }

                addResult('üéâ All Systems Go!', 'Your StoryForge Library setup is ready to use!', 'success');

            } catch (error) {
                addResult('‚ùå Client Test Failed', `Error: ${error.message}`, 'error');
            }

            btn.disabled = false;
            btn.textContent = 'Test Supabase Client';
        }

        window.testConnection = testConnection;
        window.testWithSupabaseClient = testWithSupabaseClient;

        // Auto-test on load
        setTimeout(() => {
            testConnection();
        }, 1000);
    </script>
</body>
</html>